{% extends "app_base.html" %}

{% block title %}IND Application Generator{% endblock %}

{% block header_left %}
<div class="flex items-center gap-4">
    <a href="/dashboard" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <span class="text-xl font-bold text-gray-800">IND Application Generator</span>
    <span class="px-2 py-0.5 rounded bg-orange-100 text-orange-700 text-xs font-semibold">FDA 1571</span>
</div>
{% endblock %}

{% block content %}
<style>
    /* Collapsible Section Styles */
    .collapsible-header {
        cursor: pointer;
        user-select: none;
    }

    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .collapsible-content.open {
        max-height: 2000px;
    }

    .collapse-icon {
        transition: transform 0.2s;
    }

    .collapsible-header.collapsed .collapse-icon {
        transform: rotate(180deg);
    }

    /* Form Input Styles */
    .form-input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #0077a2;
        box-shadow: 0 0 0 3px rgba(0, 119, 162, 0.1);
    }

    .form-input::placeholder {
        color: #9ca3af;
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }

    /* Help Icon */
    .help-icon {
        width: 14px;
        height: 14px;
        color: #9ca3af;
        cursor: help;
    }

    /* Custom Tooltip */
    .tooltip-trigger {
        position: relative;
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
    }

    .tooltip-content {
        visibility: hidden;
        width: 220px;
        background-color: #1f2937;
        color: #f9fafb;
        text-align: left;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 50;
        top: 135%;
        bottom: auto;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 12px;
        font-weight: 400;
        line-height: 1.4;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        pointer-events: none;
        white-space: normal; /* Ensure text wraps */
    }

    .tooltip-trigger:hover .tooltip-content {
        visibility: visible;
        opacity: 1;
    }

    .tooltip-content::after {
        content: "";
        position: absolute;
        bottom: 100%;
        top: auto;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: transparent transparent #1f2937 transparent;
    }

    /* Preview Panel */
    .markdown-preview {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #fafafa;
        padding: 16px;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
    }

    /* Loading Spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #f97316;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

        <!-- Page Description -->
        <p class="text-gray-500 text-sm mb-6">
            AI-Powered Complete IND Draft Generator - Cover Page, Protocol, Investigator's Brochure, and
            Pharmacology/Toxicology
        </p>

        <div class="flex justify-end mb-4">
            <button onclick="exportFDA1571()"
                class="bg-gray-800 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 flex items-center gap-2 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export as FDA 1571 (PDF)
            </button>
        </div>
        <script>
            function exportFDA1571() {
                const params = new URLSearchParams();
                params.set('project_id', '{{ project_id }}');
                params.set('applicant_name', document.getElementById('applicant_name')?.value || '');
                params.set('applicant_address', document.getElementById('applicant_address')?.value || '');
                params.set('applicant_phone', document.getElementById('applicant_phone')?.value || '');
                params.set('drug_name', document.getElementById('drug_name')?.value || '');
                params.set('pi_name', document.getElementById('pi_name')?.value || '');
                params.set('pi_credentials', document.getElementById('pi_credentials')?.value || '');
                window.open('/ind-generator/export-fda1571?' + params.toString(), '_blank');
            }
        </script>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- LEFT: Input Form -->
            <div class="space-y-4">

                <!-- Section 1: Applicant Information -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="collapsible-header rounded-t-xl flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Applicant Information</h3>
                                <p class="text-xs text-gray-400">Optional - Leave blank for placeholders</p>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open">
                        <div class="px-5 py-4 space-y-4">
                            <div>
                                <label class="form-label">
                                    Applicant Name
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">IND 신청서에 기재될 의뢰자(Applicant)의 공식 명칭입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="applicant_name" class="form-input" placeholder=""
                                    value="{{ form_data.applicant_name or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    Applicant Address
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">의뢰자의 공식 주소입니다. FDA와의 서신 교환에 사용됩니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="applicant_address" class="form-input" placeholder=""
                                    value="{{ form_data.applicant_address or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    Phone Number
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">의뢰자 또는 대리인의 연락처입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="applicant_phone" class="form-input" placeholder=""
                                    value="{{ form_data.applicant_phone or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Investigator & Institution -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="collapsible-header rounded-t-xl flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Investigator & Institution</h3>
                                <p class="text-xs text-gray-400">Optional - Leave blank for placeholders</p>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open">
                        <div class="px-5 py-4 space-y-4">
                            <div>
                                <label class="form-label">
                                    Principal Investigator Name
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">임상시험을 총괄할 연구 책임자(PI)의 성명입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="pi_name" class="form-input" placeholder=""
                                    value="{{ form_data.pi_name or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    PI Credentials
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">연구 책임자의 자격 및 학위 정보 (예: MD, PhD)입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="pi_credentials" class="form-input" placeholder=""
                                    value="{{ form_data.pi_credentials or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    Research Institution
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">임상시험이 수행될 연구 기관 또는 병원의 명칭입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="institution_name" class="form-input" placeholder=""
                                    value="{{ form_data.institution_name or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    Institution Address
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">연구 기관의 주소입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="institution_address" class="form-input" placeholder=""
                                    value="{{ form_data.institution_address or '' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    IRB/Ethics Committee Name
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">임상시험 계획을 심의할 임상시험심사위원회(IRB)의 명칭입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="irb_name" class="form-input" placeholder=""
                                    value="{{ form_data.irb_name or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Clinical Trial Parameters -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="collapsible-header rounded-t-xl collapsed flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Clinical Trial Parameters</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content">
                        <div class="px-5 py-4 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        Clinical Phase
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">진행하고자 하는 임상시험의 단계입니다 (1상, 2상, 3상).</span>
                                        </span>
                                    </label>
                                    <select id="clinical_phase" class="form-input"
                                        onchange="updatePhaseData(this.value)">
                                        <option value="1" {{ 'selected' if form_data and form_data.clinical_phase=='1'
                                            }}>
                                            Phase 1</option>
                                        <option value="2" {{ 'selected' if form_data and form_data.clinical_phase=='2'
                                            }}>
                                            Phase 2</option>
                                        <option value="3" {{ 'selected' if form_data and form_data.clinical_phase=='3'
                                            }}>
                                            Phase 3</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Expected Patients
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">임상시험에 모집할 예상 피험자 수입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="expected_patients" class="form-input" placeholder="30"
                                        value="{{ form_data.expected_patients or '30' }}">
                                </div>
                            </div>
                            <div>
                                <label class="form-label">
                                    Study Duration
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">임상시험의 전체 예상 기간입니다 (예: 12주, 6개월).</span>
                                    </span>
                                </label>
                                <input type="text" id="study_duration" class="form-input" placeholder="12 weeks"
                                    value="{{ form_data.study_duration or '12 weeks' }}">
                            </div>
                            <div>
                                <label class="form-label">
                                    Target Population
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">해당 Phase 시뮬레이션에서 적용된 인구 집단 정보(인종, 성별, 연령)가 자동으로 매핑됩니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="target_population" class="form-input"
                                    placeholder="Adult patients"
                                    value="{{ form_data.target_population or 'Adult patients' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Drug Candidate Info -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="collapsible-header rounded-t-xl flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Drug Candidate Info</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open">
                        <div class="px-5 py-4 space-y-4">
                            <div>
                                <label class="form-label">
                                    Drug Name
                                    <span class="text-red-500">*</span>
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">임상시험용 의약품의 명칭 또는 코드명입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="drug_name" class="form-input" placeholder="Draft Drug A"
                                    value="{{ form_data.drug_name or '' }}" required>
                            </div>
                            <div>
                                <label class="form-label">
                                    Drug Class
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">약물의 작용 기전이나 구조적 특성에 따른 분류입니다 (예: Small Molecule, Biologics).</span>
                                    </span>
                                </label>
                                <select id="drug_class" class="form-input">
                                    <option value="Small Molecule" {{ 'selected' if form_data and
                                        form_data.drug_class=='Small Molecule' }}>Small Molecule</option>
                                    <option value="Biologics" {{ 'selected' if form_data and
                                        form_data.drug_class=='Biologics' }}>Biologics</option>
                                    <option value="Peptide" {{ 'selected' if form_data and
                                        form_data.drug_class=='Peptide' }}>Peptide</option>
                                    <option value="Antibody" {{ 'selected' if form_data and
                                        form_data.drug_class=='Antibody' }}>Antibody</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">
                                    SMILES / Sequence
                                    <span class="text-red-500">*</span>
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">약물의 분자 구조를 나타내는 문자열 표기법입니다 (소분자: SMILES, 생물학적 제제: 서열).</span>
                                    </span>
                                </label>
                                <input type="text" id="smiles" class="form-input font-mono text-sm"
                                    placeholder="CCOc1ccc(cc1)C(=O)N2CCC(CC2)c3c[nH]c4c3cccc4"
                                    value="{{ form_data.smiles or '' }}" required>
                            </div>
                            <div>
                                <label class="form-label">
                                    Indication
                                    <span class="text-red-500">*</span>
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">약물이 목표로 하는 적응증(질환)입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="indication" class="form-input" placeholder="Oncology"
                                    value="{{ form_data.indication or '' }}" required>
                            </div>
                            <div>
                                <label class="form-label">
                                    Mechanism of Action
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">약물이 생체 내에서 효과를 나타내는 구체적인 작용 기전입니다.</span>
                                    </span>
                                </label>
                                <input type="text" id="mechanism" class="form-input"
                                    placeholder="예: PD-1 수용체 억제제, GLP-1 작용제" value="{{ form_data.mechanism or '' }}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        Dose (mg)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">임상시험에서 투여될 약물의 용량입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="dose_mg" class="form-input" placeholder="100"
                                        value="{{ form_data.dose_mg or '' }}" required>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Regimen
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">약물의 투여 주기 및 방법입니다 (예: QD-1일 1회, BID-1일 2회).</span>
                                        </span>
                                    </label>
                                    <select id="dosing_regimen" class="form-input">
                                        <option value="QD" {{ 'selected' if form_data and form_data.dosing_regimen=='QD'
                                            }}>
                                            QD (1일 1회)</option>
                                        <option value="BID" {{ 'selected' if form_data and
                                            form_data.dosing_regimen=='BID' }}>BID (1일 2회)</option>
                                        <option value="TID" {{ 'selected' if form_data and
                                            form_data.dosing_regimen=='TID' }}>TID (1일 3회)</option>
                                        <option value="Weekly" {{ 'selected' if form_data and
                                            form_data.dosing_regimen=='Weekly' }}>Weekly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 5: PK & Safety Data (from Models) -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm">
                    <div class="collapsible-header rounded-t-xl flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">PK & Safety Data (from Models)</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open">
                        <div class="px-5 py-4 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        Cmax (µg/mL)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">약물 투여 후 도달하는 최고 혈중 농도 예측치입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" step="0.01" id="cmax" class="form-input" placeholder="1500.5"
                                        value="{{ form_data.cmax or '' }}" required>
                                </div>
                                <div>
                                    <label class="form-label">
                                        AUC (µg·h/mL)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">혈중 약물 농도-시간 곡선 아래의 면적으로, 전신 노출도를 의미합니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" step="0.01" id="auc" class="form-input" placeholder="25000"
                                        value="{{ form_data.auc or '' }}" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        t½ (hours)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">약물의 혈중 농도가 절반으로 줄어드는 데 걸리는 시간입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" step="0.1" id="t_half" class="form-input" placeholder="12.5"
                                        value="{{ form_data.t_half or '' }}" required>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Vss (L/kg)
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">정상 상태에서의 약물 분포 용적입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" step="0.01" id="vss" class="form-input" placeholder="0.5"
                                        value="{{ form_data.vss or '' }}">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        hERG Margin (x-fold)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">심장 독성(hERG 채널 억제) 발생 가능성에 대한 안전역입니다.</span>
                                        </span>
                                    </label>
                                    <input type="number" step="0.1" id="herg_margin" class="form-input" placeholder="30"
                                        value="{{ form_data.herg_margin or '30' }}" required>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Hepatotoxicity Risk
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">간 독성 발생 위험도 예측 결과입니다.</span>
                                        </span>
                                    </label>
                                    <select id="hepato_risk" class="form-input">
                                        <option value="Low" {{ 'selected' if form_data and form_data.hepato_risk=='Low'
                                            }}>
                                            Low</option>
                                        <option value="Medium" {{ 'selected' if form_data and
                                            form_data.hepato_risk=='Medium' }}>Medium</option>
                                        <option value="High" {{ 'selected' if form_data and
                                            form_data.hepato_risk=='High' }}>High</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="form-label">
                                    QSAR Results Summary
                                    <span class="tooltip-trigger">
                                        <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="tooltip-content">구조-활성 관계(QSAR) 모델을 통한 독성 예측 결과 요약입니다.</span>
                                    </span>
                                </label>
                                <textarea id="qsar_results_formatted" class="form-input" rows="2"
                                    placeholder="No significant risks identified.">{{ form_data.qsar_results_formatted or 'No significant risks identified.' }}</textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="form-label">
                                        Overall Safety Score (0-100)
                                        <span class="text-red-500">*</span>
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">AI 모델이 예측한 종합적인 약물 안전성 점수입니다 (0-100점).</span>
                                        </span>
                                    </label>
                                    <input type="number" id="overall_score" class="form-input" placeholder="75"
                                        value="{{ form_data.overall_score or '75' }}" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Risk Category
                                        <span class="tooltip-trigger">
                                            <svg class="help-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            <span class="tooltip-content">종합 점수에 따른 안전성 위험 등급입니다.</span>
                                        </span>
                                    </label>
                                    <select id="risk_category" class="form-input">
                                        <option value="Low" {{ 'selected' if form_data and
                                            form_data.risk_category=='Low' }}>Low Risk</option>
                                        <option value="Medium" {{ 'selected' if form_data and
                                            form_data.risk_category=='Medium' }}>Medium Risk</option>
                                        <option value="High" {{ 'selected' if form_data and
                                            form_data.risk_category=='High' }}>High Risk</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generateBtn" onclick="generateIND()"
                    class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Generate Complete IND Draft
                </button>

            </div>

            <!-- RIGHT: Result Panel -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 h-fit sticky top-24">

                <!-- Initial State: Ready to Generate -->
                <div id="readyState">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-cyan-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="font-semibold text-cyan-600">Ready to Generate</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-6">
                        Fill in the drug data and click "Generate Complete IND Draft" to create the full IND application
                        document.
                    </p>

                    <h4 class="font-semibold text-gray-800 mb-3">Generated Document Sections:</h4>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 1. Cover Page</span> - Applicant info, drug
                            identification, phase
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 2. Introduction</span> - Rationale, investigational
                            plan
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 3. Clinical Protocol</span> - Phase-specific study
                            design
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 5. Investigator's Brochure</span> - Drug summary,
                            PK/Tox overview
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 8. Pharmacology & Toxicology</span> - Full
                            nonclinical data
                        </li>
                    </ul>

                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-xs text-amber-700">
                            <strong>Note</strong><br>
                            Fields left blank will appear as placeholders in the generated document for later
                            completion.
                        </p>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="spinner mb-4"></div>
                        <p class="text-gray-600 font-medium">Generating IND Application...</p>
                        <p class="text-gray-400 text-sm mt-2">This may take 30-60 seconds</p>
                    </div>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <span class="font-semibold text-green-600">Generation Successful</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">
                        Complete IND application draft has been generated including Cover Page, Protocol, Investigator's
                        Brochure, and Pharmacology/Toxicology sections.
                    </p>

                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-800">Generated Content Preview:</h4>
                        <button id="downloadBtn"
                            onclick="document.getElementById('fdaPreviewFrame').contentWindow.print()"
                            class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium rounded-lg transition flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                            </svg>
                            Print / Save as PDF
                        </button>
                    </div>

                    <div class="border border-gray-200 rounded-lg overflow-hidden h-[600px]">
                        <iframe id="fdaPreviewFrame" class="w-full h-full" src="about:blank"></iframe>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <span class="font-semibold text-red-600">Generation Failed</span>
                    </div>
                    <p id="errorMessage" class="text-gray-600 text-sm mb-4">
                        An error occurred while generating the IND document.
                    </p>
                    <button onclick="resetToReady()"
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition text-sm">
                        Try Again
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // Store the generated filename for download
    let generatedFilename = null;

    // Inject Phase Data from Backend
    const phaseData = {{ phase_data | tojson | safe }};

    function updatePhaseData(phase) {
        const data = phaseData[phase];
        if (data) {
            if (data.n_subjects) document.getElementById('expected_patients').value = data.n_subjects;
            if (data.target_population) document.getElementById('target_population').value = data.target_population;
            if (data.study_duration) document.getElementById('study_duration').value = data.study_duration;

            // Update Dose & PK Data if available from simulation
            // Use .toString() or check for existence to handle 0 values correctly
            if (data.dose_mg !== undefined && data.dose_mg !== null) document.getElementById('dose_mg').value = data.dose_mg;
            if (data.cmax !== undefined && data.cmax !== null) document.getElementById('cmax').value = data.cmax;
            if (data.auc !== undefined && data.auc !== null) document.getElementById('auc').value = data.auc;
            if (data.mean_to !== undefined && data.mean_to !== null) document.getElementById('to_trough').value = data.mean_to; // Map mean_to to to_trough if present
        } else {
            // Optional: Clear fields or keep previous values? 
            document.getElementById('expected_patients').value = "";
            document.getElementById('target_population').value = "";
            document.getElementById('study_duration').value = "";
            // We usually don't clear PK data here to allow fallback/manual entry, 
            // but if the user wants strict phase mapping, we might clear.
            // For now, let's leave PK data as is if phase data is missing (it might be the prediction base).
        }
    }

    // Toggle collapsible sections
    function toggleSection(header) {
        const content = header.nextElementSibling;
        const isOpen = content.classList.contains('open');

        if (isOpen) {
            content.style.overflow = 'hidden'; // Ensure hidden for transition
            requestAnimationFrame(() => {
                content.classList.remove('open');
                header.classList.add('collapsed');
            });
        } else {
            content.style.overflow = 'hidden'; // Ensure hidden during transition
            content.classList.add('open');
            header.classList.remove('collapsed');
            
            // Allow overflow after transition for tooltips
            setTimeout(() => {
                if(content.classList.contains('open')) {
                    content.style.overflow = 'visible';
                }
            }, 300);
        }
    }

    // Show/hide states
    function showState(stateName) {
        ['readyState', 'loadingState', 'successState', 'errorState'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(stateName).classList.remove('hidden');
    }

    function resetToReady() {
        showState('readyState');
        generatedFilename = null;
    }

    // Generate IND Document
    async function generateIND() {
        // Collect form data
        const requiredFields = ['drug_name', 'smiles', 'target_population', 'dose_mg', 'overall_score'];

        for (const field of requiredFields) {
            const el = document.getElementById(field);
            if (!el || !el.value) {
                alert(`Please fill in the required field: ${field.replace('_', ' ')}`);
                if (el) el.focus();
                return;
            }
        }

        // Show loading state
        showState('loadingState');
        document.getElementById('generateBtn').disabled = true;

        try {
            // Construct URL parameters for FDA 1571 export
            const params = new URLSearchParams();
            params.set('project_id', '{{ project_id }}');

            // Applicant Info
            params.set('applicant_name', document.getElementById('applicant_name')?.value || '');
            params.set('applicant_address', document.getElementById('applicant_address')?.value || '');
            params.set('applicant_phone', document.getElementById('applicant_phone')?.value || '');

            // Drug Info
            params.set('drug_name', document.getElementById('drug_name')?.value || '');
            params.set('smiles', document.getElementById('smiles')?.value || '');

            params.set('pi_name', document.getElementById('pi_name')?.value || '');
            params.set('pi_credentials', document.getElementById('pi_credentials')?.value || '');

            // PK/Tox Overrides
            // We set these to allow client-side edits to be reflected in the report
            params.set('indication', document.getElementById('target_population')?.value || '');
            params.set('clinical_phase', document.getElementById('clinical_phase')?.value || ''); // This is an ID check? No, value.
            params.set('dose_mg', document.getElementById('dose_mg')?.value || '');
            params.set('cmax', document.getElementById('cmax')?.value || '');
            params.set('auc', document.getElementById('auc')?.value || '');
            params.set('t_half', document.getElementById('t_half')?.value || '');
            params.set('vss', document.getElementById('vss')?.value || '');
            params.set('herg_margin', document.getElementById('herg_margin')?.value || '');
            // hepato_risk, qsar_results_formatted, risk_category
            params.set('hepato_risk', document.getElementById('hepato_risk')?.value || '');
            params.set('qsar_results', document.getElementById('qsar_results_formatted')?.value || '');
            params.set('risk_category', document.getElementById('risk_category')?.value || '');

            // Simulate loading delay for better UX
            await new Promise(r => setTimeout(r, 1000));

            // Set iframe src
            const iframe = document.getElementById('fdaPreviewFrame');
            iframe.src = `/ind-generator/export-fda1571?${params.toString()}`;

            showState('successState');
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = error.message || 'An error occurred';
            showState('errorState');
        } finally {
            document.getElementById('generateBtn').disabled = false;
        }
    }

    // Download DOCX
    function downloadDOCX() {
        if (generatedFilename) {
            window.location.href = `/api/ind/download/${generatedFilename}`;
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function () {
        const initialPhase = document.getElementById('clinical_phase').value;
        if (initialPhase) {
            updatePhaseData(initialPhase);
        }
        
        // Ensure open sections allow overflow for tooltips
        document.querySelectorAll('.collapsible-content.open').forEach(el => {
            el.style.overflow = 'visible';
        });
    });
</script>
{% endblock %}