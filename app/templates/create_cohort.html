{% extends "app_base.html" %}

{% block title %}Create Virtual Cohort - PharmaTwin{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    /* Range Slider Styling */
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        /* Default empty track color */
        border-radius: 3px;
        outline: none;
        padding: 0;
        margin: 0;
        cursor: pointer;
    }

    /* Dual Slider Track (Invisible background, track handled by div) */
    input[type="range"].dual-input {
        background: transparent !important;
        pointer-events: none;
    }

    /* Base Thumb Styling */
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        background: #ffffff;
        border: 2px solid #212b3b;
        /* Subtle border default */
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-top: 0px;
        /* Center on 6px track: (6px - 15px) / 2 = -4.5px */
        pointer-events: auto;
    }

    /* Firefox Thumb */
    input[type="range"]::-moz-range-thumb {
        width: 15px;
        height: 15px;
        background: #ffffff;
        border: 2px solid #212b3b;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        pointer-events: auto;
    }

    /* Hover State */
    input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    input[type="range"]::-moz-range-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    /* Active (Dragging) State - Deep Shadow & Blur */
    input[type="range"]:active::-webkit-slider-thumb {
        transform: scale(1.15);
        box-shadow: 0 0 0 4px rgba(0, 119, 162, 0.1), 0 4px 12px rgba(0, 0, 0, 0.25);
        border-color: transparent;
        /* Merge with shadow */
    }

    input[type="range"]:active::-moz-range-thumb {
        transform: scale(1.15);
        box-shadow: 0 0 0 4px rgba(0, 119, 162, 0.1), 0 4px 12px rgba(0, 0, 0, 0.25);
        border-color: transparent;
    }

    /* Color Variants for Thumbs (Applying Borders) - Unified to single style, keeping placeholder for reference or future specific overrides if needed */
</style>
{% endblock %}

{% block header_left %}
<div class="flex items-center gap-4">
    <a href="/projects/{{ project.id }}" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <span class="text-xl font-bold text-gray-800">{{ project.title }}</span>
    <span class="px-2 py-0.5 rounded bg-gray-100 text-xs text-gray-500 font-mono">ID: {{ project.id }}</span>
</div>
{% endblock %}

{% block content %}
<div class="p-6 max-w-[1600px] mx-auto space-y-8">

    <!-- Page Header (Animated fade-in equivalent) -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 animate-fade-in-down">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2.5 rounded-xl bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-100/50">
                    <svg class="h-6 w-6 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                </div>
                <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">
                    Advanced Cohort Settings
                </h1>
            </div>
            <p class="text-gray-500 max-w-2xl text-sm">
                한미약품 FDA 타겟 임상 데이터 기반 디지털 트윈 코호트 설정.
                유전적 다형성, 신장/간 기능, 병용 약물 등 고급 파라미터를 설정하여 정밀한 임상시험 시뮬레이션을 수행합니다.
            </p>
        </div>
        <div class="flex items-center gap-2">
            <button type="button"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Export
            </button>
            <button type="button"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z">
                    </path>
                </svg>
                Share
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left: Settings Panel (Sticky) -->
        <div class="lg:col-span-1">
            <div class="sticky top-6">
                <!-- Wrapper Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">

                    <!-- Header -->
                    <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="font-bold text-gray-800">Cohort Settings</span>
                        </div>
                        <button type="button" onclick="toggleAdvanced()"
                            class="flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0077a2] bg-blue-50 rounded hover:bg-blue-100 transition">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z">
                                </path>
                            </svg>
                            <span id="advToggleText">Advanced</span>
                        </button>
                    </div>

                    <!-- Form -->
                    <form action="/projects/{{ project.id }}/cohorts" method="POST" class="p-5 space-y-6">

                        <!-- 1. Clinical Phase -->
                        <div class="space-y-3">
                            <label class="text-xs font-bold text-[#0077a2] uppercase tracking-wider">Clinical
                                Phase</label>
                            <div class="grid grid-cols-3 gap-2">
                                <!-- Phase 1 -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="phase" value="1" class="peer sr-only" checked
                                        onchange="updatePhaseDesc(1)">
                                    <div
                                        class="text-center py-2.5 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 font-semibold text-sm transition-all hover:bg-gray-100 peer-checked:bg-[#0077a2] peer-checked:text-white peer-checked:border-[#0077a2] peer-checked:shadow-md">
                                        Phase 1
                                    </div>
                                </label>
                                <!-- Phase 2 -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="phase" value="2" class="peer sr-only"
                                        onchange="updatePhaseDesc(2)">
                                    <div
                                        class="text-center py-2.5 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 font-semibold text-sm transition-all hover:bg-gray-100 peer-checked:bg-[#0077a2] peer-checked:text-white peer-checked:border-[#0077a2] peer-checked:shadow-md">
                                        Phase 2
                                    </div>
                                </label>
                                <!-- Phase 3 -->
                                <label class="relative cursor-pointer">
                                    <input type="radio" name="phase" value="3" class="peer sr-only"
                                        onchange="updatePhaseDesc(3)">
                                    <div
                                        class="text-center py-2.5 rounded-lg border border-gray-200 bg-gray-50 text-gray-500 font-semibold text-sm transition-all hover:bg-gray-100 peer-checked:bg-[#0077a2] peer-checked:text-white peer-checked:border-[#0077a2] peer-checked:shadow-md">
                                        Phase 3
                                    </div>
                                </label>
                            </div>
                            <p id="phaseDesc"
                                class="text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100">
                                건강인 대상 안전성 및 PK 평가 (Phase 1)
                            </p>
                        </div>

                        <hr class="border-gray-100">

                        <!-- 2. Demographics -->
                        <div class="space-y-4">
                            <h3 class="flex items-center gap-2 text-sm font-bold text-gray-700">
                                <svg class="w-4 h-4 text-[#0077a2]" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                    </path>
                                </svg>
                                Demographics
                            </h3>

                            <!-- Population -->
                            <div>
                                <label class="block text-xs font-medium text-gray-500 mb-1">Race / Population</label>
                                <div class="relative">
                                    <select name="pop"
                                        class="w-full appearance-none bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 focus:ring-[#0077a2] focus:border-[#0077a2]">
                                        <option value="ASN" selected>Asian (ASN)</option>
                                        <option value="EUR">European (EUR)</option>
                                        <option value="AFR">African (AFR)</option>
                                        <option value="MIX">Mixed Population</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Sample Size -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs font-medium text-gray-500">Sample Size (Subjects)</label>
                                    <span id="nVal" class="text-xs font-bold text-[#212b3b]">1000</span>
                                </div>
                                <input type="range" name="n_subjects" value="1000" min="10" max="5000" step="10"
                                    class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    oninput="document.getElementById('nVal').innerText = this.value">
                                <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                                    <span>10</span>
                                    <span>5000</span>
                                </div>
                            </div>

                            <!-- Age Range -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-xs font-medium text-gray-500">Age Range</label>
                                    <span class="text-xs font-bold text-[#212b3b]"><span id="age-min-val">18</span> -
                                        <span id="age-max-val">80</span></span>
                                </div>
                                <div class="relative w-full h-6 flex items-center">
                                    <!-- Track -->
                                    <div class="absolute w-full h-1.5 bg-gray-200 rounded-full"></div>
                                    <div id="age-track" class="absolute h-1.5 bg-[#212b3b] rounded-full z-10"></div>

                                    <!-- Sliders -->
                                    <input type="range" name="age_min" id="input-age-min" min="0" max="100" value="18"
                                        class="absolute w-full h-1.5 dual-input appearance-none cursor-pointer z-20"
                                        oninput="updateDualSlider('age', 0, 100)">

                                    <input type="range" name="age_max" id="input-age-max" min="0" max="100" value="80"
                                        class="absolute w-full h-1.5 dual-input appearance-none cursor-pointer z-20"
                                        oninput="updateDualSlider('age', 0, 100)">
                                </div>
                            </div>

                            <!-- Gender Ratio -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-medium text-blue-500">Male</span>
                                    <span class="text-xs font-medium text-pink-500">Female: <span
                                            id="female-val">50%</span></span>
                                </div>
                                <input type="range" name="female_ratio" min="0" max="1" step="0.01" value="0.5"
                                    class="w-full h-1.5 bg-gradient-to-r from-blue-200 to-pink-200 rounded-lg appearance-none cursor-pointer"
                                    oninput="document.getElementById('female-val').innerText = Math.round(this.value * 100) + '%'">
                            </div>
                        </div>



                        <!-- Advanced Settings (Collapsible Accordions) -->
                        <div id="advancedSettings" class="hidden space-y-4 animate-fade-in-down">
                            <hr class="border-gray-100">

                            <!-- Genetic Polymorphism -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
                                <button type="button"
                                    class="w-full px-5 py-3 flex items-center justify-between bg-gray-50/50 hover:bg-gray-50 transition-colors"
                                    onclick="toggleAccordion('genetic-content', this)">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded-lg bg-purple-50 text-purple-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                                </path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Genetic Polymorphism</span>
                                        <span
                                            class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">Pharmacogenomics</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="genetic-content" class="hidden p-5 space-y-5 border-t border-gray-100">
                                    <!-- Target Enzyme -->
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Target
                                            Enzyme</label>
                                        <select name="enzyme"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                                            <option value="CYP2D6">CYP2D6</option>
                                            <option value="CYP2C19">CYP2C19</option>
                                            <option value="CYP3A4">CYP3A4</option>
                                            <option value="UGT1A1">UGT1A1</option>
                                        </select>
                                    </div>

                                    <!-- Phenotype Dist Sliders -->
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="text-xs font-medium text-gray-500">Phenotype
                                                Distribution</label>
                                        </div>

                                        <!-- PM -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 text-[10px] font-mono text-gray-500">PM</span>
                                            <input type="range" name="pheno_pm" value="5" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="document.getElementById('pm-val').innerText = this.value + '%'">
                                            <span id="pm-val"
                                                class="w-8 text-right text-xs font-bold text-purple-600">5%</span>
                                        </div>
                                        <!-- IM -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 text-[10px] font-mono text-gray-500">IM</span>
                                            <input type="range" name="pheno_im" value="25" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="document.getElementById('im-val').innerText = this.value + '%'">
                                            <span id="im-val"
                                                class="w-8 text-right text-xs font-bold text-purple-600">25%</span>
                                        </div>
                                        <!-- EM -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 text-[10px] font-mono text-gray-500">EM</span>
                                            <input type="range" name="pheno_em" value="65" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="document.getElementById('em-val').innerText = this.value + '%'">
                                            <span id="em-val"
                                                class="w-8 text-right text-xs font-bold text-purple-600">65%</span>
                                        </div>
                                        <!-- UM -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 text-[10px] font-mono text-gray-500">UM</span>
                                            <input type="range" name="pheno_um" value="5" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="document.getElementById('um-val').innerText = this.value + '%'">
                                            <span id="um-val"
                                                class="w-8 text-right text-xs font-bold text-purple-600">5%</span>
                                        </div>
                                    </div>

                                    <!-- Quick Presets -->
                                    <div class="pt-2">
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Quick
                                            Presets</label>
                                        <div class="flex flex-wrap gap-2">
                                            <button type="button" onclick="setGeneticPreset('cyp2d6_pm')"
                                                class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-lg hover:border-purple-300 hover:text-purple-600 transition shadow-sm">CYP2D6
                                                PM Cohort</button>
                                            <button type="button" onclick="setGeneticPreset('cyp2c19_asian')"
                                                class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-lg hover:border-purple-300 hover:text-purple-600 transition shadow-sm">CYP2C19
                                                Asian</button>
                                            <button type="button"
                                                class="px-3 py-1.5 text-xs bg-white border border-gray-200 rounded-lg hover:border-purple-300 hover:text-purple-600 transition shadow-sm">UGT1A1*28
                                                Cohort</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Body Metrics -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
                                <button type="button"
                                    class="w-full px-5 py-3 flex items-center justify-between bg-gray-50/50 hover:bg-gray-50 transition-colors"
                                    onclick="toggleAccordion('body-content', this)">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded-lg bg-blue-50 text-blue-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3">
                                                </path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Body Metrics (BMI/BSA)</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="body-content" class="hidden p-5 space-y-6 border-t border-gray-100">
                                    <!-- BMI Range Dual Slider -->
                                    <div>
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-xs font-medium text-gray-500">BMI Range (kg/m²)</label>
                                            <span class="text-xs font-bold text-[#212b3b]"><span
                                                    id="bmi-min-val">18.5</span> - <span
                                                    id="bmi-max-val">30.0</span></span>
                                        </div>
                                        <div class="relative w-full h-6 flex items-center">
                                            <!-- Track Background -->
                                            <div class="absolute w-full h-1.5 bg-gray-200 rounded-full"></div>
                                            <!-- Active Track -->
                                            <div id="bmi-track" class="absolute h-1.5 bg-[#212b3b] rounded-full z-10">
                                            </div>

                                            <!-- Sliders (Invisible but clickable) -->
                                            <!-- Style Note: Z-index ensures thumbs are clickable. Special CSS class creates pointer-events-auto for thumb only -->
                                            <input type="range" name="bmi_min" id="input-bmi-min" min="15" max="50"
                                                step="0.5" value="18.5"
                                                class="absolute w-full h-1.5 dual-input appearance-none cursor-pointer z-20"
                                                oninput="updateDualSlider('bmi', 15, 50)">

                                            <input type="range" name="bmi_max" id="input-bmi-max" min="15" max="50"
                                                step="0.5" value="30.0"
                                                class="absolute w-full h-1.5 dual-input appearance-none cursor-pointer z-20"
                                                oninput="updateDualSlider('bmi', 15, 50)">


                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Weight
                                            Distribution</label>
                                        <select name="bmi_dist"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                            <option value="normal">Normal Distribution</option>
                                            <option value="lognormal">Log-normal (Realistic)</option>
                                            <option value="uniform">Uniform</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Organ Function -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
                                <button type="button"
                                    class="w-full px-5 py-3 flex items-center justify-between bg-gray-50/50 hover:bg-gray-50 transition-colors"
                                    onclick="toggleAccordion('organ-content', this)">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded-lg bg-red-50 text-red-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                                </path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Organ Function</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="organ-content" class="hidden p-5 space-y-5 border-t border-gray-100">
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="text-xs font-medium text-gray-500">Renal Function (eGFR
                                                Distribution)</label>
                                        </div>

                                        <!-- Normal -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-16 text-[10px] text-gray-500">Normal</span>
                                            <input type="range" name="renal_normal" value="100" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="this.nextElementSibling.innerText = this.value + '%'">
                                            <span class="w-8 text-right text-xs font-bold text-cyan-600">100%</span>
                                        </div>
                                        <!-- Mild -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-16 text-[10px] text-gray-500">Mild</span>
                                            <input type="range" name="renal_mild" value="0" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="this.nextElementSibling.innerText = this.value + '%'">
                                            <span class="w-8 text-right text-xs font-bold text-cyan-600">0%</span>
                                        </div>
                                        <!-- Moderate -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-16 text-[10px] text-gray-500">Moderate</span>
                                            <input type="range" name="renal_mod" value="0" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="this.nextElementSibling.innerText = this.value + '%'">
                                            <span class="w-8 text-right text-xs font-bold text-cyan-600">0%</span>
                                        </div>
                                        <!-- Severe -->
                                        <div class="flex items-center gap-3">
                                            <span class="w-16 text-[10px] text-gray-500">Severe</span>
                                            <input type="range" name="renal_sev" value="0" min="0" max="100"
                                                class="flex-1 h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                oninput="this.nextElementSibling.innerText = this.value + '%'">
                                            <span class="w-8 text-right text-xs font-bold text-cyan-600">0%</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Hepatic Function
                                            (Child-Pugh)</label>
                                        <select name="hepatic_grade"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
                                            <option value="normal">Normal (A, 5-6점)</option>
                                            <option value="mild">Mild Allowed (A-B)</option>
                                            <option value="moderate">Moderate Allowed (B)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Concomitant Meds (DDI) -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
                                <button type="button"
                                    class="w-full px-5 py-3 flex items-center justify-between bg-gray-50/50 hover:bg-gray-50 transition-colors"
                                    onclick="toggleAccordion('ddi-content', this)">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded-lg bg-green-50 text-green-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                                </path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Concomitant Medications
                                            (DDI)</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="ddi-content" class="hidden p-5 space-y-4 border-t border-gray-100">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Indication
                                            Preset</label>
                                        <select id="ddiIndication" onchange="updateDDIMeds()"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500">
                                            <option value="diabetes">당뇨 (Diabetes)</option>
                                            <option value="obesity">비만 (Obesity)</option>
                                            <option value="oncology">항암 (Oncology)</option>
                                            <option value="nash">간 질환 (NASH/NAFLD)</option>
                                        </select>
                                    </div>
                                    <div id="ddiList" class="grid grid-cols-2 gap-3">
                                        <!-- Populated via JS -->
                                    </div>
                                    <input type="hidden" name="concomitant_meds" id="inputMeds">
                                </div>
                            </div>

                            <!-- Dosing Regimen (Added) -->
                            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
                                <button type="button"
                                    class="w-full px-5 py-3 flex items-center justify-between bg-gray-50/50 hover:bg-gray-50 transition-colors"
                                    onclick="toggleAccordion('dosing-content', this)">
                                    <div class="flex items-center gap-3">
                                        <div class="p-1.5 rounded-lg bg-teal-50 text-teal-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                                </path>
                                            </svg>
                                        </div>
                                        <span class="text-sm font-bold text-gray-700">Dosing Regimen</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-400 transform transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="dosing-content" class="hidden p-5 space-y-4 border-t border-gray-100">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Regimen Type</label>
                                        <select name="regimen_type"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-teal-500">
                                            <option value="escalation">Dose Escalation (3+3)</option>
                                            <option value="dose_finding">Dose Finding</option>
                                            <option value="fixed">Fixed Dose</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-500 mb-2">Frequency</label>
                                        <select name="frequency"
                                            class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2.5 outline-none focus:border-teal-500">
                                            <option value="QD">QD (Once Daily)</option>
                                            <option value="BID">BID (Twice Daily)</option>
                                            <option value="QW">QW (Once Weekly)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <hr class="border-gray-100">
                        </div>

                        <!-- 3. PK Parameters (Always Visible) -->
                        <div class="space-y-4 pt-2">
                            <div class="flex justify-between items-center">
                                <h3 class="flex items-center gap-2 text-sm font-bold text-gray-700">
                                    <svg class="w-4 h-4 text-[#0077a2]" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    PK Parameters
                                </h3>
                                <!-- Auto Toggle -->
                                <div class="flex bg-gray-100 p-0.5 rounded text-[10px]">
                                    <button type="button" onclick="setMode('auto')" id="btnAuto"
                                        class="px-2 py-0.5 rounded bg-white shadow text-[#0077a2] font-bold">Auto</button>
                                    <button type="button" onclick="setMode('manual')" id="btnManual"
                                        class="px-2 py-0.5 rounded text-gray-500">Manual</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase">CL (mL/min/kg)</label>
                                    <input type="number" step="0.01" name="cl" id="inputCL"
                                        value="{{ '%.2f'|format(prediction.result_json.pk.human_CL_mL_min_kg_linear) if prediction else '' }}"
                                        data-auto-value="{{ '%.2f'|format(prediction.result_json.pk.human_CL_mL_min_kg_linear) if prediction else '' }}"
                                        class="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm text-gray-500 font-mono"
                                        readonly>
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase">Vd (L/kg)</label>
                                    <input type="number" step="0.01" name="vd" id="inputVD"
                                        value="{{ '%.2f'|format(prediction.result_json.pk.human_VDss_L_kg_linear) if prediction else '' }}"
                                        data-auto-value="{{ '%.2f'|format(prediction.result_json.pk.human_VDss_L_kg_linear) if prediction else '' }}"
                                        class="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm text-gray-500 font-mono"
                                        readonly>
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase">MW (g/mol)</label>
                                    <input type="number" step="0.01" name="mw" id="inputMW"
                                        value="{{ prediction.result_json.properties.mw if prediction else '' }}"
                                        data-auto-value="{{ prediction.result_json.properties.mw if prediction else '' }}"
                                        class="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm text-gray-500 font-mono"
                                        readonly>
                                </div>
                                <div>
                                    <label class="text-[10px] text-gray-500 uppercase">fu</label>
                                    <input type="number" step="0.01" name="fu" id="inputFU"
                                        value="{{ '%.2f'|format(prediction.result_json.pk.human_fup) if prediction else '0.9' }}"
                                        data-auto-value="{{ '%.2f'|format(prediction.result_json.pk.human_fup) if prediction else '0.9' }}"
                                        class="w-full bg-gray-50 border border-gray-200 rounded p-1.5 text-sm text-gray-500 font-mono"
                                        readonly>
                                </div>
                                <!-- Hidden default for ratio handled in demographics, adding hidden input for compatibility if needed or reusing the one above -->
                                <input type="hidden" name="female_ratio" value="0.5">
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit"
                                class="w-full bg-[#0077a2] hover:bg-[#005a7a] text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-900/10 transition transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Run Visual Simulation
                            </button>
                            <p class="text-[10px] text-center text-gray-400 mt-2">Estimation: ~1s (N=100) - ~5s (N=1000)
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right: Preview & Guide -->
        <div class="lg:col-span-2 space-y-6">

            {% if cohorts %}
            <!-- COHORT LIST (Shows FIRST if cohorts exist) -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                        Generated Cohorts
                    </h3>
                    <span class="bg-blue-100 text-[#0077a2] text-xs font-bold px-2 py-0.5 rounded-full">{{
                        cohorts|length }} Results</span>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for cohort in cohorts %}
                    {% set phase = cohort.demographics.get('phase', '1')|string %}
                    {% set badge_color = 'bg-blue-50 text-blue-700 border-blue-100' if phase == '1' else ('bg-purple-50
                    text-purple-700 border-purple-100' if phase == '2' else 'bg-green-50 text-green-700
                    border-green-100') %}

                    <a href="/projects/{{ project.id }}/cohorts/{{ cohort.id }}"
                        class="block group p-4 rounded-xl border border-gray-100 hover:border-[#0077a2]/30 hover:shadow-md transition bg-white relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <span class="border px-2 py-0.5 rounded text-[10px] font-bold {{ badge_color }}">Phase {{
                                phase }}</span>
                            <span class="text-xs text-gray-400">{{ cohort.created_at.strftime('%m-%d %H:%M') }}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 group-hover:text-[#0077a2] mb-1 truncate">{{ cohort.name }}
                        </h4>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <span>N={{ cohort.demographics.n }}</span>
                            <span>•</span>
                            <span>{{ cohort.demographics.pop }}</span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- SETTINGS GUIDE (Shows below list if cohorts exist, or top if empty) -->
            <div class="space-y-6">
                <!-- Summary Guide -->
                <div class="p-6 rounded-xl border border-gray-200 bg-white/50 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-1.5 rounded bg-amber-50">
                            <svg class="h-5 w-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                                </path>
                            </svg>
                        </div>
                        <h3 class="font-bold text-gray-800">설정 가이드</h3>
                    </div>

                    <div class="space-y-3 text-sm text-gray-600">
                        <div class="p-4 rounded-lg bg-[#0077a2]/5 border border-[#0077a2]/10">
                            <h4 class="font-bold text-[#0077a2] mb-1">Phase 연동 자동 설정</h4>
                            <p>임상 단계(Phase 1/2/3)를 선택하면 관련 옵션들이 자동으로 조정됩니다. Phase 1은 건강인 기준, Phase 2/3은 환자 기준이 적용됩니다.
                            </p>
                        </div>
                        <div class="p-4 rounded-lg bg-cyan-50 border border-cyan-100">
                            <h4 class="font-bold text-cyan-700 mb-1">유전체 시나리오 프리셋</h4>
                            <p>CYP2D6 PM Cohort, CYP2C19 Asian 등 FDA 제출용 유전체 시나리오를 원클릭으로 생성할 수 있습니다.</p>
                        </div>
                        <div class="p-4 rounded-lg bg-orange-50 border border-orange-100">
                            <h4 class="font-bold text-orange-700 mb-1">동적 PK 영향 계산</h4>
                            <p>설정 변경 시 실시간으로 PK 영향(AUC, Cmax, T½ 변화)을 예측하여 가이드 문구를 표시합니다.</p>
                        </div>
                    </div>
                </div>

                <!-- Feature Grid (Visual Only) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-xl border border-purple-100 bg-gradient-to-br from-purple-50 to-pink-50">
                        <h4 class="font-bold text-purple-800 mb-1">유전적 다형성</h4>
                        <p class="text-sm text-purple-600/80">CYP2D6, CYP2C19 등 대사 효소 유전자형 분포 설정</p>
                    </div>
                    <div class="p-4 rounded-xl border border-blue-100 bg-gradient-to-br from-blue-50 to-cyan-50">
                        <h4 class="font-bold text-blue-800 mb-1">신체 지표</h4>
                        <p class="text-sm text-blue-600/80">BMI, BSA 범위 및 분포 설정</p>
                    </div>
                    <div class="p-4 rounded-xl border border-green-100 bg-gradient-to-br from-green-50 to-emerald-50">
                        <h4 class="font-bold text-green-800 mb-1">병용 약물 (DDI)</h4>
                        <p class="text-sm text-green-600/80">적응증별 병용 약물 프리셋 및 DDI 시뮬레이션</p>
                    </div>
                    <div class="p-4 rounded-xl border border-red-100 bg-gradient-to-br from-orange-50 to-red-50">
                        <h4 class="font-bold text-red-800 mb-1">신장/간 기능</h4>
                        <p class="text-sm text-red-600/80">eGFR, Child-Pugh 기반 장기 기능 분포 설정</p>
                    </div>
                </div>

                <!-- FDA Note -->
                <div class="p-6 rounded-xl border border-blue-200 bg-blue-50/50">
                    <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <span class="text-[#0077a2]">FDA MIDD</span> 준수
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        본 시뮬레이션 시스템은 FDA Model-Informed Drug Development (MIDD) 가이던스를 준수하여 설계되었습니다.
                    </p>
                    <div class="grid grid-cols-3 gap-2 text-xs font-mono text-[#0077a2]">
                        <div class="bg-white/60 p-1.5 rounded text-center">Cmax</div>
                        <div class="bg-white/60 p-1.5 rounded text-center">Tmax</div>
                        <div class="bg-white/60 p-1.5 rounded text-center">AUC0-inf</div>
                        <div class="bg-white/60 p-1.5 rounded text-center">T½</div>
                        <div class="bg-white/60 p-1.5 rounded text-center">CL/F</div>
                        <div class="bg-white/60 p-1.5 rounded text-center">Vd/F</div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Loading Overlay (Reused from previous) -->
<div id="loadingOverlay"
    class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-[#0077a2] mb-4"></div>
    <h2 class="text-xl font-bold text-gray-800">Generating Virtual Cohort</h2>
    <p class="text-sm text-gray-500 mt-2">Running Monte Carlo Simulations...</p>
</div>

<script>
    // Advanced Toggle
    function toggleAdvanced() {
        const advPanel = document.getElementById('advancedSettings');
        const toggleText = document.getElementById('advToggleText');

        if (advPanel.classList.contains('hidden')) {
            advPanel.classList.remove('hidden');
            toggleText.innerText = 'Simple';
        } else {
            advPanel.classList.add('hidden');
            toggleText.innerText = 'Advanced';
        }
    }

    // Interactive Logic for Advanced Settings
    function setGeneticPreset(id) {
        if (id === 'cyp2d6_pm') {
            document.querySelector("select[name='enzyme']").value = "CYP2D6";
            document.querySelector("input[name='pheno_pm']").value = 100;
            document.querySelector("input[name='pheno_im']").value = 0;
            document.querySelector("input[name='pheno_em']").value = 0;
            document.querySelector("input[name='pheno_um']").value = 0;
        } else if (id === 'cyp2c19_asian') {
            document.querySelector("select[name='enzyme']").value = "CYP2C19";
            document.querySelector("input[name='pheno_pm']").value = 20;
            document.querySelector("input[name='pheno_im']").value = 35;
            document.querySelector("input[name='pheno_em']").value = 40;
            document.querySelector("input[name='pheno_um']").value = 5;
        }
    }

    // DDI Logic
    const DDI_PRESETS = {
        'diabetes': ['Metformin', 'Glimepiride', 'Empagliflozin', 'Atorvastatin'],
        'obesity': ['Metformin', 'Orlistat', 'Phentermine'],
        'oncology': ['Ondansetron', 'Dexamethasone', 'Ketoconazole'],
        'nash': ['Metformin', 'Vitamin E', 'Atorvastatin']
    };

    function updateDDIMeds() {
        const indication = document.getElementById('ddiIndication').value;
        const listDiv = document.getElementById('ddiList');
        const meds = DDI_PRESETS[indication] || [];

        listDiv.innerHTML = meds.map(m => `
            <label class="flex items-center gap-2 p-2 border border-gray-200 rounded cursor-pointer hover:bg-blue-50 transition">
                <input type="checkbox" value="${m}" class="rounded text-blue-600 focus:ring-blue-500" onchange="updateMedInput()">
                <span class="text-xs text-gray-700">${m}</span>
            </label>
        `).join('');
        updateMedInput();
    }

    function updateMedInput() {
        // Collect checked meds
        const checkboxes = document.querySelectorAll('#ddiList input[type="checkbox"]:checked');
        const values = Array.from(checkboxes).map(c => c.value);
        document.getElementById('inputMeds').value = values.join(',');
    }

    // Initialize DDI meds
    updateDDIMeds();

    // Standard Logic
    function updatePhaseDesc(p) {
        const desc = document.getElementById('phaseDesc');
        if (p == 1) desc.innerText = "건강인 대상 안전성 및 PK 평가 (Phase 1)";
        if (p == 2) desc.innerText = "환자 대상 개념 증명 및 용량 탐색 (Phase 2)";
        if (p == 3) desc.innerText = "환자 대상 확증 임상시험 (Phase 3)";
    }

    function setMode(mode) {
        const inputs = ['inputCL', 'inputVD', 'inputMW', 'inputFU'];
        const btnAuto = document.getElementById('btnAuto');
        const btnManual = document.getElementById('btnManual');

        if (mode === 'auto') {
            btnAuto.classList.add('bg-white', 'shadow', 'text-[#0077a2]', 'font-bold');
            btnAuto.classList.remove('text-gray-500');
            btnManual.classList.remove('bg-white', 'shadow', 'text-[#0077a2]', 'font-bold');
            btnManual.classList.add('text-gray-500');
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = true;
                el.classList.add('bg-gray-50', 'text-gray-500');
                if (el.dataset.autoValue) el.value = el.dataset.autoValue;
            });
        } else {
            btnManual.classList.add('bg-white', 'shadow', 'text-[#0077a2]', 'font-bold');
            btnManual.classList.remove('text-gray-500');
            btnAuto.classList.remove('bg-white', 'shadow', 'text-[#0077a2]', 'font-bold');
            btnAuto.classList.add('text-gray-500');
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = false;
                el.classList.remove('bg-gray-50', 'text-gray-500', 'cursor-not-allowed');
                el.value = '';
            });
        }
    }

    // Accordion Logic
    function toggleAccordion(contentId, button) {
        const content = document.getElementById(contentId);
        const icon = button.querySelector('svg:last-child');

        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            icon.classList.add('rotate-180');
        } else {
            content.classList.add('hidden');
            icon.classList.remove('rotate-180');
        }
    }

    // Dual Slider Logic
    function updateDualSlider(prefix, minTotal, maxTotal) {
        const inputMin = document.getElementById(`input-${prefix}-min`);
        const inputMax = document.getElementById(`input-${prefix}-max`);
        const track = document.getElementById(`${prefix}-track`);
        const valMin = document.getElementById(`${prefix}-min-val`);
        const valMax = document.getElementById(`${prefix}-max-val`);

        let minVal = parseFloat(inputMin.value);
        let maxVal = parseFloat(inputMax.value);

        // Simple crossing prevention
        if (minVal > maxVal) {
            // Swap visually for track, but keeping values is safer for form unless we swap inputs
            const temp = minVal;
            minVal = maxVal;
            maxVal = temp;
        }

        const range = maxTotal - minTotal;
        const leftPercent = ((minVal - minTotal) / range) * 100;
        const widthPercent = ((maxVal - minVal) / range) * 100;

        track.style.left = leftPercent + "%";
        track.style.width = widthPercent + "%";

        if (valMin) valMin.innerText = Math.min(parseFloat(inputMin.value), parseFloat(inputMax.value));
        if (valMax) valMax.innerText = Math.max(parseFloat(inputMin.value), parseFloat(inputMax.value));
    }

    // Initialize Logic
    document.addEventListener('DOMContentLoaded', () => {
        try {
            updateDualSlider('bmi', 15, 50);
            updateDualSlider('age', 0, 100);

            // Init Single Slider Fills
            document.querySelectorAll('input[type="range"]:not(.dual-input)').forEach(slider => {
                updateSliderFill(slider);
                slider.addEventListener('input', (e) => updateSliderFill(e.target));
            });
        } catch (e) { console.log("Slider init error", e); }
    });

    // Single Slider Fill Logic (Progress Bar)
    function updateSliderFill(slider) {
        if (slider.name === 'female_ratio') return; // Skip Gradient Slider (it has its own CSS gradient)

        const val = parseFloat(slider.value);
        const min = parseFloat(slider.min) || 0;
        const max = parseFloat(slider.max) || 100;
        const percent = ((val - min) / (max - min)) * 100;

        // Determine color based on class
        let color = '#212b3b'; // Unified Dark Navy


        slider.style.background = `linear-gradient(to right, ${color} ${percent}%, #e2e8f0 ${percent}%)`;
    }

    // Auto submit spinner
    document.querySelector('form').addEventListener('submit', function (e) {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('loadingOverlay').classList.add('flex');
    });
</script>
{% endblock %}