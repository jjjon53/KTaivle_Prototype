{% extends "app_base.html" %}

{% block title %}{{ project.title }} - PharmaTwin{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    /* Card Styles */
    .content-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Metric Card */
    .metric-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Info Tooltip (Renamed to avoid conflict with Sidebar tooltips) */
    .info-tooltip-container {
        position: relative;
        display: inline-flex;
        align-items: center;
    }

    .info-tooltip-icon {
        width: 14px;
        height: 14px;
        background: #0077a2;
        color: white;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        cursor: help;
        margin-left: 4px;
        transition: all 0.2s;
    }

    .info-tooltip-icon:hover {
        background: #005a7a;
        transform: scale(1.1);
    }

    .info-tooltip-text {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        z-index: 100;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #e2e8f0;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
    }

    .info-tooltip-text::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1e293b;
    }

    .info-tooltip-container:hover .info-tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block header_left %}
<div class="flex items-center gap-4">
    <a href="/dashboard" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <span class="text-xl font-bold text-gray-800">{{ project.title }}</span>
    <span class="px-2 py-0.5 rounded bg-gray-100 text-xs text-gray-500 font-mono">ID: {{ project.id }}</span>
</div>
{% endblock %}

{% block content %}
<main class="p-6 max-w-7xl mx-auto">

    <!-- New Analysis Card -->
    <div class="content-card p-6 mb-6">
        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
            New Analysis
        </h2>
        <form id="predictForm" action="/projects/{{ project.id }}/predict" method="post" class="flex gap-4 items-start">
            <div class="flex-1">
                <input type="text" name="smiles" required
                    placeholder="Enter SMILES string (e.g., CC(=O)Oc1ccccc1C(=O)O)"
                    class="w-full border border-gray-300 rounded-lg p-3 text-gray-800 focus:outline-none focus:border-[#0077a2] focus:ring-1 focus:ring-[#0077a2] font-mono text-sm transition">
                <p class="text-xs text-gray-400 mt-2">Example (Aspirin): CC(=O)Oc1ccccc1C(=O)O</p>
            </div>
            <button type="submit" id="submitBtn"
                class="px-6 py-3 bg-[#0077a2] hover:bg-[#005a7a] text-white font-bold rounded-lg shadow-md transition flex items-center gap-2 whitespace-nowrap disabled:opacity-50">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span id="btnText">Run Prediction</span>
            </button>
        </form>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 hidden flex-col items-center justify-center">
        <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1548 1521"
            class="w-16 h-16 mb-4 animate-spin" style="animation-duration: 2s;">
            <path fill="#0077a2"
                d="m1434.3 795.3c0-10.2 0-19.8 0-29.3h-245.7q1.4 14.3 1.4 28.6c0 250.5-199.5 453.4-444.5 453.4-245.8 0-484.7-213.1-498.3-482h-124.6c0-9.5-0.7-19.1-0.7-28.6 0-274.4 157.3-512 384.6-626.3l-45.6-111c-83 40.2-159.3 94.6-226 162.7-151.1 153.9-234.1 358.8-234.1 576 0 217.8 76.9 389.4 216.4 531.7 140.9 143.6 328.1 222.6 528.3 222.6 379.8 0 688.8-313.2 688.8-697.8z" />
            <path fill="#0077a2"
                d="m1333.6 267.6c-139.6-142.2-324.7-219.9-522.1-219.9-369 0-670.5 298.9-680.7 670.6q0 1.4 0 3.4 0 8.2 0 16.4 0 10.2 0 19.7h228c0-6.1 0-12.9 0-19.7 0-254.6 202.9-461.6 452.7-461.6 249.8 0 488.7 212.4 507.1 481.3h123.2v8.2c1.4 10.9 1.4 20.4 1.4 29.3 0 274.3-155.2 512.6-381.9 629.7l40.2 96c78.9-39.5 151.1-91.9 214.4-156.6 149.7-152.5 232.1-354.7 232.1-569.8 0-198.8-76.2-386-214.4-527z" />
        </svg>
        <p class="text-xl font-bold text-gray-800">Analyzing...</p>
        <p class="text-sm text-gray-500 mt-2">Calculating PK, Toxicity, and LD50 predictions</p>
    </div>

    <script>
        document.getElementById('predictForm').addEventListener('submit', function (e) {
            const overlay = document.getElementById('loadingOverlay');
            const btn = document.getElementById('submitBtn');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            btn.disabled = true;
        });
    </script>

    <!-- Predictions Section -->
    <div class="space-y-8">
        {% for pred in project.predictions|reverse %}
        <div class="content-card overflow-hidden">

            <!-- Card Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span
                        class="bg-[#0077a2]/10 text-[#0077a2] px-3 py-1 rounded-full text-xs font-mono border border-[#0077a2]/20">#{{
                        pred.id }}</span>
                    <code class="text-sm text-gray-600 break-all max-w-xl">{{ pred.smiles }}</code>
                </div>
                <span class="text-xs text-gray-400">{{ pred.created_at.strftime('%Y-%m-%d %H:%M:%S')
                    }}</span>
            </div>

            <!-- Card Body -->
            <div class="p-6 space-y-6">

                <!-- ROW 1: Key Metrics Summary -->
                {% set high_risk_count = 0 %}
                {% for task, res in pred.result_json.tox21.items() %}
                {% if res.risk == 'HIGH' %}{% set high_risk_count = high_risk_count + 1 %}{% endif %}
                {% endfor %}

                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <!-- LD50 -->
                    <div
                        class="metric-card border-l-4 {% if pred.result_json.ld50.class in ['I', 'II'] %}border-red-500{% elif pred.result_json.ld50.class in ['III', 'IV'] %}border-yellow-500{% else %}border-green-500{% endif %}">
                        <div class="text-xs text-gray-500 mb-1 info-tooltip-container">
                            LD50
                            <span class="info-tooltip-icon">i</span>
                            <span class="info-tooltip-text">반수치사량: 실험동물 50%가 사망하는 용량</span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">{{ pred.result_json.ld50.value }}
                            <span class="text-xs font-normal text-gray-400">mg/kg</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            Class {{ pred.result_json.ld50.class }} {% if pred.result_json.ld50.label %}({{
                            pred.result_json.ld50.label }}){% endif %}
                        </div>
                    </div>
                    <!-- Human CL -->
                    <div class="metric-card border-l-4 border-[#0077a2]">
                        <div class="text-xs text-gray-500 mb-1 info-tooltip-container">
                            Human CL
                            <span class="info-tooltip-icon">i</span>
                            <span class="info-tooltip-text">청소율 (Clearance)</span>
                        </div>
                        <div class="text-2xl font-bold text-[#0077a2]">{{
                            "%.2f"|format(pred.result_json.pk.human_CL_mL_min_kg_linear) }} <span
                                class="text-xs font-normal text-gray-400">mL/min/kg</span></div>
                    </div>
                    <!-- Human Vdss -->
                    <div class="metric-card border-l-4 border-cyan-500">
                        <div class="text-xs text-gray-500 mb-1 info-tooltip-container">
                            Human Vdss
                            <span class="info-tooltip-icon">i</span>
                            <span class="info-tooltip-text">분포용적 (Volume of Distribution)</span>
                        </div>
                        <div class="text-2xl font-bold text-cyan-600">{{
                            "%.2f"|format(pred.result_json.pk.human_VDss_L_kg_linear) }} <span
                                class="text-xs font-normal text-gray-400">L/kg</span></div>
                    </div>
                    <!-- Human t1/2 -->
                    <div class="metric-card border-l-4 border-indigo-500">
                        <div class="text-xs text-gray-500 mb-1 info-tooltip-container">
                            Human t½
                            <span class="info-tooltip-icon">i</span>
                            <span class="info-tooltip-text">반감기 (Half-life)</span>
                        </div>
                        <div class="text-2xl font-bold text-indigo-600">{{
                            "%.2f"|format(pred.result_json.pk.human_thalf_linear) }} <span
                                class="text-xs font-normal text-gray-400">h</span></div>
                    </div>
                    <!-- Tox21 Risk -->
                    {% set high_risk_count = 0 %}
                    {% for task, res in pred.result_json.tox21.items() %}
                    {% if res is mapping %}
                    {% if res.risk == 'HIGH' or res.probability >= 0.7 %}
                    {% set high_risk_count = high_risk_count + 1 %}
                    {% endif %}
                    {% elif res is number and res >= 0.7 %}
                    {% set high_risk_count = high_risk_count + 1 %}
                    {% endif %}
                    {% endfor %}
                    <div
                        class="metric-card border-l-4 {% if high_risk_count >= 3 %}border-red-500{% elif high_risk_count >= 1 %}border-yellow-500{% else %}border-green-500{% endif %}">
                        <div class="text-xs text-gray-500 mb-1 info-tooltip-container">
                            Tox21 Risk
                            <span class="info-tooltip-icon">i</span>
                            <span class="info-tooltip-text">고위험 독성 경로 수</span>
                        </div>
                        <div
                            class="text-2xl font-bold {% if high_risk_count >= 3 %}text-red-600{% elif high_risk_count >= 1 %}text-yellow-600{% else %}text-green-600{% endif %}">
                            {{ high_risk_count }}/12
                        </div>
                    </div>
                </div>

                <!-- ROW 2: Physico Props & Gauge Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: Physicochemical Properties (Vertical) -->
                    <div class="content-card p-5">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                            Physicochemical Properties
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">MW (g/mol)<span
                                        class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">분자량
                                            (Molecular Weight): 분자의 질량을 나타내며, 약물의 흡수 및 분포에 영향을
                                            줌</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.mw }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">LogP<span class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">분배계수: 지질
                                            친화도를 나타내며, 세포막 투과성과 관련됨</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.logp }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">TPSA (Å²)<span
                                        class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">극성 표면적:
                                            분자 표면의 극성 부분의 합, 경구 흡수율 예측에 중요</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.tpsa }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">H-Bond Donors<span
                                        class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">수소결합 공여체
                                            수: 용해도와 투과성에 영향</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.hbd }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">H-Bond Acceptors<span
                                        class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">수소결합 수용체
                                            수: 용해도와 투과성에 영향</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.hba }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-sm text-gray-600">Rotatable Bonds<span
                                        class="info-tooltip-container ml-1"><span
                                            class="info-tooltip-icon">i</span><span class="info-tooltip-text">회전 가능한
                                            결합 수: 분자의 유연성을 나타내며, 경구 생체이용률과 관련</span></span></span>
                                <span class="text-sm font-semibold text-gray-800">{{
                                    pred.result_json.properties.rotatable_bonds }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Gauge Charts -->
                    <div class="content-card p-5 lg:col-span-2">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Human PK Metrics
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- t1/2 -->
                            <div class="text-center">
                                <div class="relative h-40">
                                    <canvas id="gaugeThalf-{{ pred.id }}"></canvas>
                                </div>
                                <div class="text-xl font-bold text-indigo-600 mt-2">{{
                                    "%.2f"|format(pred.result_json.pk.human_thalf_linear) }} h</div>
                                <div class="text-sm text-gray-500">Half-life</div>
                            </div>
                            <!-- MRT -->
                            <div class="text-center">
                                <div class="relative h-40">
                                    <canvas id="gaugeMRT-{{ pred.id }}"></canvas>
                                </div>
                                <div class="text-xl font-bold text-purple-600 mt-2">{{
                                    "%.2f"|format(pred.result_json.pk.human_mrt_linear) }} h</div>
                                <div class="text-sm text-gray-500">MRT</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROW 3: Species Table & Tox21 List -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Species PK Table -->
                    <div class="content-card p-5">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2z" />
                            </svg>
                            Interspecies PK Parameters<span class="info-tooltip-container ml-1"><span
                                    class="info-tooltip-icon">i</span><span class="info-tooltip-text">종간 PK 파라미터: 4가지
                                    종의 주요 약동학 변수 비교</span></span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-600 font-medium border-b">
                                    <tr>
                                        <th class="py-2 px-3">Species</th>
                                        <th class="py-2 px-3">CL<span class="info-tooltip-container ml-1"><span
                                                    class="info-tooltip-icon">i</span><span
                                                    class="info-tooltip-text">청소율 (Clearance): 약물이 체내에서 제거되는
                                                    속도</span></span> (mL/min/kg)</th>
                                        <th class="py-2 px-3">VDss<span class="info-tooltip-container ml-1"><span
                                                    class="info-tooltip-icon">i</span><span
                                                    class="info-tooltip-text">분포용적 (Vdss): 약물이 체내 조직으로 분포되는
                                                    정도</span></span> (L/kg)</th>
                                        <th class="py-2 px-3">FUP<span class="info-tooltip-container ml-1"><span
                                                    class="info-tooltip-icon">i</span><span
                                                    class="info-tooltip-text">비결합 분율 (Fraction unbound): 혈장 단백질과
                                                    결합하지 않은 약물의 비율</span></span> (%)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <tr>
                                        <td class="py-2 px-3 text-gray-600">Rat</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.rat_CL_mL_min_kg_linear) if
                                            pred.result_json.pk.rat_CL_mL_min_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.rat_VDss_L_kg_linear) if
                                            pred.result_json.pk.rat_VDss_L_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{ "%.1f"|format(pred.result_json.pk.rat_fup *
                                            100) if pred.result_json.pk.rat_fup else '-' }}%</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 px-3 text-gray-600">Dog</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.dog_CL_mL_min_kg_linear) if
                                            pred.result_json.pk.dog_CL_mL_min_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.dog_VDss_L_kg_linear) if
                                            pred.result_json.pk.dog_VDss_L_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{ "%.1f"|format(pred.result_json.pk.dog_fup *
                                            100) if pred.result_json.pk.dog_fup else '-' }}%</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 px-3 text-gray-600">Monkey</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.monkey_CL_mL_min_kg_linear) if
                                            pred.result_json.pk.monkey_CL_mL_min_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{
                                            "%.2f"|format(pred.result_json.pk.monkey_VDss_L_kg_linear) if
                                            pred.result_json.pk.monkey_VDss_L_kg_linear else '-' }}</td>
                                        <td class="py-2 px-3">{{
                                            "%.1f"|format(pred.result_json.pk.monkey_fup * 100) if
                                            pred.result_json.pk.monkey_fup else '-' }}%</td>
                                    </tr>
                                    <tr class="bg-blue-50/50">
                                        <td class="py-2 px-3 font-bold text-[#0077a2]">Human</td>
                                        <td class="py-2 px-3 font-bold text-[#0077a2]">{{
                                            "%.2f"|format(pred.result_json.pk.human_CL_mL_min_kg_linear) }}
                                        </td>
                                        <td class="py-2 px-3 font-bold text-[#0077a2]">{{
                                            "%.2f"|format(pred.result_json.pk.human_VDss_L_kg_linear) }}
                                        </td>
                                        <td class="py-2 px-3 font-bold text-[#0077a2]">{{
                                            "%.1f"|format(pred.result_json.pk.human_fup * 100) }}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tox21 List -->
                    <div class="content-card p-5">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            Tox21 Assay Details<span class="info-tooltip-container ml-1"><span
                                    class="info-tooltip-icon">i</span><span class="info-tooltip-text">21가지 독성 기전 분석 결과
                                    상세</span></span>
                        </h3>

                        <!-- Header -->
                        <div class="flex text-[10px] text-gray-400 font-bold mb-3 px-2 uppercase tracking-wider">
                            <div class="w-1/3">ASSAY<span class="info-tooltip-container ml-1"><span
                                        class="info-tooltip-icon">i</span><span class="info-tooltip-text">독성 테스트 항목
                                        (Assay)</span></span></div>
                            <div class="w-1/2 text-center">PROB.<span class="info-tooltip-container ml-1"><span
                                        class="info-tooltip-icon">i</span><span class="info-tooltip-text">AI가 예측한 독성
                                        발현 확률 (0~1)</span></span></div>
                            <div class="w-1/6 text-right">RISK<span class="info-tooltip-container ml-1"><span
                                        class="info-tooltip-icon">i</span><span class="info-tooltip-text">확률 기반 위험도 등급
                                        (High/Low)</span></span></div>
                        </div>

                        <div class="h-64 overflow-y-auto pr-2 space-y-1 custom-scrollbar">
                            {% for task, res in pred.result_json.tox21.items() %}
                            {% set prob = res.probability if res is mapping else res %}

                            <div
                                class="flex items-center justify-between text-xs px-2 py-2 hover:bg-gray-50 rounded transition-colors">
                                <!-- Assay Name -->
                                <div class="w-1/3 font-medium text-gray-600 truncate pr-2" title="{{ task }}">{{ task }}
                                </div>

                                <!-- Bar & Value -->
                                <div class="w-1/2 flex items-center gap-2">
                                    <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full rounded-full {% if prob >= 0.7 %}bg-red-400{% elif prob >= 0.3 %}bg-yellow-400{% else %}bg-green-400{% endif %}"
                                            style="width: {{ prob * 100 }}%"></div>
                                    </div>
                                    <span class="text-gray-500 w-8 text-right font-mono text-[10px]">{{
                                        "%.2f"|format(prob) }}</span>
                                </div>

                                <!-- Risk Badge -->
                                <div class="w-1/6 text-right">
                                    {% if prob >= 0.7 %}
                                    <span
                                        class="inline-flex items-center justify-center px-2 py-0.5 rounded text-[9px] font-bold bg-red-50 text-red-600 border border-red-100 min-w-[36px]">HIGH</span>
                                    {% elif prob >= 0.3 %}
                                    <span
                                        class="inline-flex items-center justify-center px-2 py-0.5 rounded text-[9px] font-bold bg-yellow-50 text-yellow-600 border border-yellow-100 min-w-[36px]">MED</span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center justify-center px-2 py-0.5 rounded text-[9px] font-bold bg-green-50 text-green-600 border border-green-100 min-w-[36px]">LOW</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="border-b border-dashed border-gray-50 mx-2"></div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <!-- ROW 4: Advanced Plots -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- PK Line Plot -->
                    <div class="content-card p-5">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-[#0077a2]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                            </svg>
                            Interspecies PK Comparison<span class="info-tooltip-container ml-1"><span
                                    class="info-tooltip-icon">i</span><span class="info-tooltip-text">종간 PK 비교: 동물
                                    모델(쥐, 개, 원숭이)과 사람의 CL 및 Vdss 비교</span></span>
                        </h3>
                        <div class="relative h-64">
                            <canvas id="pkBarChart-{{ pred.id }}"></canvas>
                        </div>
                        <p class="text-xs text-center text-gray-400 mt-2">Comparison of Clearance (CL) and
                            Volume (Vdss)</p>
                    </div>

                    <!-- Tox21 Radar Plot -->
                    <div class="content-card p-5">
                        <h3 class="text-sm font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                            </svg>
                            Safety Fingerprint<span class="info-tooltip-container ml-1"><span
                                    class="info-tooltip-icon">i</span><span class="info-tooltip-text">화합물의 안전성을 시각화한
                                    지문 (Radar Chart)</span></span>
                        </h3>
                        <div class="relative h-64">
                            <canvas id="toxRadar-{{ pred.id }}"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end gap-3">
                    <!-- Report Button -->
                    <button type="button"
                        class="px-4 py-2 border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 rounded-lg text-sm font-medium transition flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Generate Report
                    </button>

                    <!-- Next Step Button (Virtual Cohort) -->
                    <a href="/projects/{{ project.id }}/cohorts/new?pred_id={{ pred.id }}"
                        class="px-4 py-2 bg-[#0077a2] hover:bg-[#005a7a] text-white rounded-lg text-sm font-medium transition flex items-center gap-2 shadow-sm group">
                        <span>Next Step: Virtual Cohort</span>
                        <svg class="w-4 h-4 text-white/80 group-hover:translate-x-0.5 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </a>
                </div>

                <!-- Scripts -->
                <script>
                    (function () {
                        // 1. Gauge Charts
                        var thalfVal = {{ pred.result_json.pk.human_thalf_linear|default (0)
                    }};
                    var mrtVal = {{ pred.result_json.pk.human_mrt_linear|default (0) }};
                    var clVal = {{ pred.result_json.pk.human_CL_mL_min_kg_linear|default (0) }};
                    var vdssVal = {{ pred.result_json.pk.human_VDss_L_kg_linear|default (0) }};

                    var commonOptions = { rotation: -90, circumference: 180, cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

                    new Chart(document.getElementById('gaugeThalf-{{ pred.id }}'), { type: 'doughnut', data: { datasets: [{ data: [Math.min(thalfVal / 48, 1), 1 - Math.min(thalfVal / 48, 1)], backgroundColor: ['#6366F1', '#e5e7eb'], borderWidth: 0 }] }, options: commonOptions });
                    new Chart(document.getElementById('gaugeMRT-{{ pred.id }}'), { type: 'doughnut', data: { datasets: [{ data: [Math.min(mrtVal / 72, 1), 1 - Math.min(mrtVal / 72, 1)], backgroundColor: ['#A855F7', '#e5e7eb'], borderWidth: 0 }] }, options: commonOptions });

                    // 2. Interspecies PK Bar Chart
                    var ratCL = {{ pred.result_json.pk.rat_CL_mL_min_kg_linear|default (0) }};
                    var dogCL = {{ pred.result_json.pk.dog_CL_mL_min_kg_linear|default (0) }};
                    var monkeyCL = {{ pred.result_json.pk.monkey_CL_mL_min_kg_linear|default (0) }};
                    var humanCL = {{ pred.result_json.pk.human_CL_mL_min_kg_linear|default (0) }};

                    var ratVd = {{ pred.result_json.pk.rat_VDss_L_kg_linear|default (0) }};
                    var dogVd = {{ pred.result_json.pk.dog_VDss_L_kg_linear|default (0) }};
                    var monkeyVd = {{ pred.result_json.pk.monkey_VDss_L_kg_linear|default (0) }};
                    var humanVd = {{ pred.result_json.pk.human_VDss_L_kg_linear|default (0) }};

                    new Chart(document.getElementById('pkBarChart-{{ pred.id }}'), {
                        type: 'bar',
                        data: {
                            labels: ['Rat', 'Dog', 'Monkey', 'Human'],
                            datasets: [
                                { label: 'Clearance (mL/min/kg)', data: [ratCL, dogCL, monkeyCL, humanCL], backgroundColor: '#5DADEC', borderRadius: 4 },
                                { label: 'Volume (L/kg)', data: [ratVd, dogVd, monkeyVd, humanVd], backgroundColor: '#9F7AEA', borderRadius: 4 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } },
                            scales: {
                                y: { type: 'logarithmic', title: { display: true, text: 'Value (Log Scale)' }, min: 0.1 },
                                x: { grid: { display: false } }
                            }
                        }
                    });

                    // 3. Tox21 Radar Chart
                    var toxLabels = [];
                    var toxData = [];
                    {% for task, res in pred.result_json.tox21.items() %}
                    toxLabels.push("{{ task }}");
                    {% if res is mapping %}
                    toxData.push({{ res.probability |default(0) }});
                    {% else %}
                    toxData.push({{ res|default(0) }});
                    {% endif %}
                    {% endfor %}

                    new Chart(document.getElementById('toxRadar-{{ pred.id }}'), {
                        type: 'radar',
                        data: {
                            labels: toxLabels,
                            datasets: [{
                                label: 'Probability',
                                data: toxData,
                                borderColor: '#EF4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                                pointBackgroundColor: '#EF4444'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { r: { suggestedMin: 0, suggestedMax: 1, grid: { color: 'rgba(0,0,0,0.05)' } } }
                        }
                    });
                        }) ();
                </script>

            </div>
        </div>
        {% else %}
        <div class="content-card p-12 text-center">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
            <h3 class="text-gray-500 font-medium mb-2">No analyses yet</h3>
            <p class="text-gray-400 text-sm">Start by entering a SMILES string above to run your first
                prediction.</p>
        </div>
        {% endfor %}
    </div>
</main>
{% endblock %}