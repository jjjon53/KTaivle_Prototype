{% extends "app_base.html" %}

{% block title %}IND Application Generator{% endblock %}

{% block header_left %}
<div class="flex items-center gap-4">
    <a href="/dashboard" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <span class="text-xl font-bold text-gray-800">IND Application Generator</span>
    <span class="px-2 py-0.5 rounded bg-orange-100 text-orange-700 text-xs font-semibold">FDA 21 CFR 312.23</span>
</div>
{% endblock %}

{% block content %}
<style>
    /* Collapsible Section Styles */
    .collapsible-header {
        cursor: pointer;
        user-select: none;
    }

    .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .collapsible-content.open {
        max-height: 2000px;
    }

    .collapse-icon {
        transition: transform 0.2s;
    }

    .collapsible-header.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }

    /* Form Input Styles */
    .form-input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #0077a2;
        box-shadow: 0 0 0 3px rgba(0, 119, 162, 0.1);
    }

    .form-input::placeholder {
        color: #9ca3af;
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }

    /* Help Icon */
    .help-icon {
        width: 14px;
        height: 14px;
        color: #9ca3af;
        cursor: help;
    }

    /* Preview Panel */
    .markdown-preview {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #fafafa;
        padding: 16px;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
    }

    /* Loading Spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #f97316;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<div class="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

        <!-- Page Description -->
        <p class="text-gray-500 text-sm mb-6">
            AI-Powered Complete IND Draft Generator - Cover Page, Protocol, Investigator's Brochure, and
            Pharmacology/Toxicology
        </p>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- LEFT: Input Form -->
            <div class="space-y-4">

                <!-- Section 1: Applicant Information -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="collapsible-header flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Applicant Information</h3>
                                <p class="text-xs text-gray-400">Optional - Leave blank for placeholders</p>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open px-5 py-4 space-y-4">
                        <div>
                            <label class="form-label">Applicant Name</label>
                            <input type="text" id="applicant_name" class="form-input"
                                placeholder="Enter applicant/sponsor name"
                                value="{{ form_data.applicant_name if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">Applicant Address</label>
                            <input type="text" id="applicant_address" class="form-input"
                                placeholder="Enter full address"
                                value="{{ form_data.applicant_address if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="text" id="applicant_phone" class="form-input" placeholder="Enter phone number"
                                value="{{ form_data.applicant_phone if form_data else '' }}">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Investigator & Institution -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="collapsible-header flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Investigator & Institution</h3>
                                <p class="text-xs text-gray-400">Optional - Leave blank for placeholders</p>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content px-5 py-4 space-y-4">
                        <div>
                            <label class="form-label">Principal Investigator Name</label>
                            <input type="text" id="pi_name" class="form-input" placeholder="e.g., Dr. John Smith"
                                value="{{ form_data.pi_name if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">PI Credentials</label>
                            <input type="text" id="pi_credentials" class="form-input" placeholder="e.g., MD, PhD, FACP"
                                value="{{ form_data.pi_credentials if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">Research Institution</label>
                            <input type="text" id="institution_name" class="form-input"
                                placeholder="e.g., Seoul National University Hospital"
                                value="{{ form_data.institution_name if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">Institution Address</label>
                            <input type="text" id="institution_address" class="form-input"
                                placeholder="Enter institution address"
                                value="{{ form_data.institution_address if form_data else '' }}">
                        </div>
                        <div>
                            <label class="form-label">IRB/Ethics Committee Name</label>
                            <input type="text" id="irb_name" class="form-input"
                                placeholder="e.g., Institutional Review Board"
                                value="{{ form_data.irb_name if form_data else '' }}">
                        </div>
                    </div>
                </div>

                <!-- Section 3: Clinical Trial Parameters -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="collapsible-header flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Clinical Trial Parameters</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open px-5 py-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Clinical Phase</label>
                                <select id="clinical_phase" class="form-input">
                                    <option value="1">Phase 1</option>
                                    <option value="2">Phase 2</option>
                                    <option value="3">Phase 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Expected Patients</label>
                                <input type="number" id="expected_patients" class="form-input" placeholder="30"
                                    value="30">
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Study Duration</label>
                            <input type="text" id="study_duration" class="form-input" placeholder="12 weeks"
                                value="12 weeks">
                        </div>
                        <div>
                            <label class="form-label">Target Population</label>
                            <input type="text" id="target_population" class="form-input" placeholder="Adult patients"
                                value="Adult patients">
                        </div>
                    </div>
                </div>

                <!-- Section 4: Drug Candidate Info -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="collapsible-header flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">Drug Candidate Info</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open px-5 py-4 space-y-4">
                        <div>
                            <label class="form-label">
                                Drug Name
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="drug_name" class="form-input" placeholder="Draft Drug A"
                                value="{{ report.title.replace('IND Submission - ', '') if report else '' }}" required>
                        </div>
                        <div>
                            <label class="form-label">Drug Class</label>
                            <select id="drug_class" class="form-input">
                                <option value="Small Molecule">Small Molecule</option>
                                <option value="Biologics">Biologics</option>
                                <option value="Peptide">Peptide</option>
                                <option value="Antibody">Antibody</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">
                                SMILES / Sequence
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="smiles" class="form-input font-mono text-sm"
                                placeholder="CCOc1ccc(cc1)C(=O)N2CCC(CC2)c3c[nH]c4c3cccc4"
                                value="{{ form_data.smiles if form_data else '' }}" required>
                        </div>
                        <div>
                            <label class="form-label">
                                Indication
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="indication" class="form-input" placeholder="Oncology"
                                value="Oncology" required>
                        </div>
                        <div>
                            <label class="form-label">Mechanism of Action</label>
                            <input type="text" id="mechanism" class="form-input"
                                placeholder="예: PD-1 수용체 억제제, GLP-1 작용제"
                                value="{{ form_data.mechanism if form_data else '' }}">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">
                                    Dose (mg)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="dose_mg" class="form-input" placeholder="100" value="100"
                                    required>
                            </div>
                            <div>
                                <label class="form-label">Regimen</label>
                                <select id="dosing_regimen" class="form-input">
                                    <option value="QD">QD (1일 1회)</option>
                                    <option value="BID">BID (1일 2회)</option>
                                    <option value="TID">TID (1일 3회)</option>
                                    <option value="Weekly">Weekly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 5: PK & Safety Data (from Models) -->
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="collapsible-header flex items-center justify-between px-5 py-4 border-b border-gray-100"
                        onclick="toggleSection(this)">
                        <div class="flex items-center gap-3">
                            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <div>
                                <h3 class="font-semibold text-gray-800">PK & Safety Data (from Models)</h3>
                            </div>
                        </div>
                        <svg class="collapse-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="collapsible-content open px-5 py-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">
                                    Cmax (ng/mL)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" step="0.01" id="cmax" class="form-input" placeholder="1500.5"
                                    value="1500" required>
                            </div>
                            <div>
                                <label class="form-label">
                                    AUC (ng·h/mL)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" step="0.01" id="auc" class="form-input" placeholder="25000"
                                    value="25000" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">
                                    t½ (hours)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" step="0.1" id="t_half" class="form-input" placeholder="12.5"
                                    value="12" required>
                            </div>
                            <div>
                                <label class="form-label">Vss (L/kg)</label>
                                <input type="number" step="0.01" id="vss" class="form-input" placeholder="0.5"
                                    value="0.5">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">
                                    hERG Margin (x-fold)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" step="0.1" id="herg_margin" class="form-input" placeholder="30"
                                    value="30" required>
                            </div>
                            <div>
                                <label class="form-label">Hepatotoxicity Risk</label>
                                <select id="hepato_risk" class="form-input">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">QSAR Results Summary</label>
                            <textarea id="qsar_results_formatted" class="form-input" rows="2"
                                placeholder="No significant risks identified.">No significant risks identified.</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">
                                    Overall Safety Score (0-100)
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="overall_score" class="form-input" placeholder="75" value="75"
                                    min="0" max="100" required>
                            </div>
                            <div>
                                <label class="form-label">Risk Category</label>
                                <select id="risk_category" class="form-input">
                                    <option value="Low">Low Risk</option>
                                    <option value="Medium">Medium Risk</option>
                                    <option value="High">High Risk</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button id="generateBtn" onclick="generateIND()"
                    class="w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Generate Complete IND Draft
                </button>

            </div>

            <!-- RIGHT: Result Panel -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 h-fit sticky top-24">

                <!-- Initial State: Ready to Generate -->
                <div id="readyState">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-cyan-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <span class="font-semibold text-cyan-600">Ready to Generate</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-6">
                        Fill in the drug data and click "Generate Complete IND Draft" to create the full IND application
                        document.
                    </p>

                    <h4 class="font-semibold text-gray-800 mb-3">Generated Document Sections:</h4>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 1. Cover Page</span> - Applicant info, drug
                            identification, phase
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 2. Introduction</span> - Rationale, investigational
                            plan
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 3. Clinical Protocol</span> - Phase-specific study
                            design
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 5. Investigator's Brochure</span> - Drug summary,
                            PK/Tox overview
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">• 8. Pharmacology & Toxicology</span> - Full
                            nonclinical data
                        </li>
                    </ul>

                    <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                        <p class="text-xs text-amber-700">
                            <strong>Note</strong><br>
                            Fields left blank will appear as placeholders in the generated document for later
                            completion.
                        </p>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden">
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="spinner mb-4"></div>
                        <p class="text-gray-600 font-medium">Generating IND Application...</p>
                        <p class="text-gray-400 text-sm mt-2">This may take 30-60 seconds</p>
                    </div>
                </div>

                <!-- Success State -->
                <div id="successState" class="hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <span class="font-semibold text-green-600">Generation Successful</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">
                        Complete IND application draft has been generated including Cover Page, Protocol, Investigator's
                        Brochure, and Pharmacology/Toxicology sections.
                    </p>

                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-semibold text-gray-800">Generated Content Preview:</h4>
                        <button id="downloadBtn" onclick="downloadDOCX()"
                            class="px-4 py-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium rounded-lg transition flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download DOCX
                        </button>
                    </div>

                    <div id="previewContent" class="markdown-preview border border-gray-200">
                        <!-- Content will be inserted by JavaScript -->
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                            <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </div>
                        <span class="font-semibold text-red-600">Generation Failed</span>
                    </div>
                    <p id="errorMessage" class="text-gray-600 text-sm mb-4">
                        An error occurred while generating the IND document.
                    </p>
                    <button onclick="resetToReady()"
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition text-sm">
                        Try Again
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // Store the generated filename for download
    let generatedFilename = null;

    // Toggle collapsible sections
    function toggleSection(header) {
        const content = header.nextElementSibling;
        const isOpen = content.classList.contains('open');

        if (isOpen) {
            content.classList.remove('open');
            header.classList.add('collapsed');
        } else {
            content.classList.add('open');
            header.classList.remove('collapsed');
        }
    }

    // Show/hide states
    function showState(stateName) {
        ['readyState', 'loadingState', 'successState', 'errorState'].forEach(s => {
            document.getElementById(s).classList.add('hidden');
        });
        document.getElementById(stateName).classList.remove('hidden');
    }

    function resetToReady() {
        showState('readyState');
        generatedFilename = null;
    }

    // Generate IND Document
    async function generateIND() {
        // Collect form data
        const requiredFields = ['drug_name', 'smiles', 'indication', 'dose_mg', 'cmax', 'auc', 't_half', 'herg_margin', 'overall_score'];

        for (const field of requiredFields) {
            const el = document.getElementById(field);
            if (!el.value) {
                alert(`Please fill in the required field: ${field.replace('_', ' ')}`);
                el.focus();
                return;
            }
        }

        // Show loading state
        showState('loadingState');
        document.getElementById('generateBtn').disabled = true;

        const formData = {
            // Applicant
            applicant_name: document.getElementById('applicant_name').value,
            applicant_address: document.getElementById('applicant_address').value,
            applicant_phone: document.getElementById('applicant_phone').value,

            // Investigator
            pi_name: document.getElementById('pi_name').value,
            pi_credentials: document.getElementById('pi_credentials').value,
            institution_name: document.getElementById('institution_name').value,
            institution_address: document.getElementById('institution_address').value,
            irb_name: document.getElementById('irb_name').value,

            // Clinical Trial
            clinical_phase: document.getElementById('clinical_phase').value,
            expected_patients: document.getElementById('expected_patients').value,
            study_duration: document.getElementById('study_duration').value,
            target_population: document.getElementById('target_population').value,

            // Drug
            drug_name: document.getElementById('drug_name').value,
            drug_class: document.getElementById('drug_class').value,
            smiles: document.getElementById('smiles').value,
            indication: document.getElementById('indication').value,
            mechanism: document.getElementById('mechanism').value,
            dose_mg: parseFloat(document.getElementById('dose_mg').value),
            dosing_regimen: document.getElementById('dosing_regimen').value,

            // PK & Safety
            cmax: parseFloat(document.getElementById('cmax').value),
            auc: parseFloat(document.getElementById('auc').value),
            t_half: parseFloat(document.getElementById('t_half').value),
            vss: parseFloat(document.getElementById('vss').value) || 0,
            herg_margin: parseFloat(document.getElementById('herg_margin').value),
            hepato_risk: document.getElementById('hepato_risk').value,
            qsar_results_formatted: document.getElementById('qsar_results_formatted').value,
            overall_score: parseFloat(document.getElementById('overall_score').value),
            risk_category: document.getElementById('risk_category').value,
            ames_result: "Negative"  // Default
        };

        try {
            const response = await fetch('/api/ind/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Generation failed');
            }

            const result = await response.json();

            // Store filename for download
            generatedFilename = result.filename;

            // Show preview
            document.getElementById('previewContent').textContent = result.text;
            showState('successState');

        } catch (error) {
            console.error('Generation error:', error);
            document.getElementById('errorMessage').textContent = error.message;
            showState('errorState');
        } finally {
            document.getElementById('generateBtn').disabled = false;
        }
    }

    // Download DOCX
    function downloadDOCX() {
        if (generatedFilename) {
            window.location.href = `/api/ind/download/${generatedFilename}`;
        }
    }
</script>
{% endblock %}